<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Program Absen Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ“š Program Absen Kelas</h1>
            <p class="text-gray-600">Kelola kehadiran siswa dengan mudah</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-8">
            <div class="bg-white rounded-lg p-1 shadow-lg">
                <button onclick="showTab('absen')" id="tab-absen" class="px-6 py-3 rounded-md font-medium transition-all bg-blue-500 text-white">
                    âœ… Absen Hari Ini
                </button>
                <button onclick="showTab('siswa')" id="tab-siswa" class="px-6 py-3 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500">
                    ğŸ‘¥ Kelola Siswa
                </button>
                <button onclick="showTab('rekap')" id="tab-rekap" class="px-6 py-3 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500">
                    ğŸ“‹ Rekap Siswa
                </button>
                <button onclick="showTab('laporan')" id="tab-laporan" class="px-6 py-3 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500">
                    ğŸ“Š Laporan
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Absen Tab -->
            <div id="content-absen" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Absensi Hari Ini</h2>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Tanggal</p>
                            <p class="font-semibold text-gray-800" id="current-date"></p>
                        </div>
                    </div>
                    
                    <div id="absen-list" class="space-y-3">
                        <!-- Daftar siswa untuk absen akan muncul di sini -->
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <button onclick="markAllPresent()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            âœ… Tandai Semua Hadir
                        </button>
                        <button onclick="saveAttendance()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            ğŸ’¾ Simpan Absensi
                        </button>
                    </div>
                </div>
            </div>

            <!-- Kelola Siswa Tab -->
            <div id="content-siswa" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Kelola Data Siswa</h2>
                    
                    <!-- Form Tambah Siswa -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-gray-700 mb-3">Tambah Siswa Baru</h3>
                        <form onsubmit="addStudent(event)" class="flex gap-3">
                            <input type="text" id="student-name" placeholder="Nama Siswa" required 
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <input type="text" id="student-id" placeholder="NIS (Opsional)" 
                                   class="w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                â• Tambah
                            </button>
                        </form>
                    </div>

                    <!-- Daftar Siswa -->
                    <div id="student-list" class="space-y-2">
                        <!-- Daftar siswa akan muncul di sini -->
                    </div>
                </div>
            </div>

            <!-- Rekap Siswa Tab -->
            <div id="content-rekap" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Rekap Kehadiran Per Siswa</h2>
                        <div class="flex space-x-3">
                            <button onclick="exportStudentRecap()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <span>ğŸ“Š</span>
                                <span>Ekspor Rekap</span>
                            </button>
                            <button onclick="refreshStudentRecap()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                ğŸ”„ Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Filter Periode -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-gray-700 mb-3">Filter Periode Rekap</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Dari Tanggal</label>
                                <input type="date" id="recap-start-date" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Sampai Tanggal</label>
                                <input type="date" id="recap-end-date" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div class="flex items-end">
                                <button onclick="applyRecapFilter()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors w-full">
                                    ğŸ” Terapkan Filter
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Search Box -->
                    <div class="mb-4">
                        <input type="text" id="student-search" placeholder="ğŸ” Cari nama siswa..." 
                               onkeyup="searchStudent()" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <!-- Rekap Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 rounded-lg">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">No</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">NIS</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Nama Siswa</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-green-700">âœ… Hadir</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-red-700">âŒ Tidak Hadir</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-yellow-700">ğŸ“ Izin</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-orange-700">ğŸ¤’ Sakit</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-blue-700">ğŸ“Š Total Hari</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-purple-700">ğŸ“ˆ % Kehadiran</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">ğŸ“‹ Detail</th>
                                </tr>
                            </thead>
                            <tbody id="student-recap-table">
                                <!-- Data rekap akan muncul di sini -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary Statistics -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600" id="avg-attendance">0%</div>
                            <div class="text-sm text-green-700">Rata-rata Kehadiran Kelas</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="total-days-recap">0</div>
                            <div class="text-sm text-blue-700">Total Hari Absensi</div>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600" id="best-attendance">-</div>
                            <div class="text-sm text-purple-700">Kehadiran Terbaik</div>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-600" id="needs-attention">0</div>
                            <div class="text-sm text-orange-700">Perlu Perhatian (&lt;75%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Laporan Tab -->
            <div id="content-laporan" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Laporan Kehadiran</h2>
                    
                    <!-- Statistik -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-present">0</div>
                            <div class="text-sm text-green-700">Total Hadir</div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-red-600" id="total-absent">0</div>
                            <div class="text-sm text-red-700">Total Tidak Hadir</div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="total-izin">0</div>
                            <div class="text-sm text-yellow-700">Total Izin</div>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-600" id="total-sakit">0</div>
                            <div class="text-sm text-orange-700">Total Sakit</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="total-students">0</div>
                            <div class="text-sm text-blue-700">Total Siswa</div>
                        </div>
                    </div>

                    <!-- Filter Controls -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-gray-700 mb-3">Filter Rekap</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Dari Tanggal</label>
                                <input type="date" id="filter-start-date" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Sampai Tanggal</label>
                                <input type="date" id="filter-end-date" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Status</label>
                                <select id="filter-status" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Semua Status</option>
                                    <option value="hadir">Hadir</option>
                                    <option value="tidak-hadir">Tidak Hadir</option>
                                    <option value="izin">Izin</option>
                                    <option value="sakit">Sakit</option>
                                </select>
                            </div>
                            <div class="flex items-end space-x-2">
                                <button onclick="applyFilter()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                    ğŸ” Filter
                                </button>
                                <button onclick="resetFilter()" 
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                    ğŸ”„ Reset
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Export Controls -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-blue-700 mb-3">ğŸ“Š Ekspor Data</h3>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="exportToExcel('all')" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <span>ğŸ“‹</span>
                                <span>Ekspor Semua Data</span>
                            </button>
                            <button onclick="exportToExcel('filtered')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <span>ğŸ”</span>
                                <span>Ekspor Data Terfilter</span>
                            </button>
                            <button onclick="exportStudentList()" 
                                    class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <span>ğŸ‘¥</span>
                                <span>Ekspor Daftar Siswa</span>
                            </button>
                            <button onclick="exportSummaryReport()" 
                                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <span>ğŸ“ˆ</span>
                                <span>Ekspor Laporan Ringkasan</span>
                            </button>
                        </div>
                    </div>

                    <!-- Riwayat Absensi -->
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-gray-700">Riwayat Absensi</h3>
                            <div class="text-sm text-gray-500" id="filter-info">
                                Menampilkan semua data
                            </div>
                        </div>
                        <div id="attendance-history" class="space-y-2">
                            <!-- Riwayat akan muncul di sini -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photo-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800" id="modal-title">Absen Foto</h3>
                    <button onclick="closePhotoModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                
                <div class="text-center mb-4">
                    <div class="w-64 h-48 bg-gray-100 rounded-lg mx-auto mb-4 overflow-hidden" id="camera-container">
                        <video id="camera-video" class="w-full h-full object-cover hidden" autoplay playsinline></video>
                        <canvas id="photo-canvas" class="w-full h-full object-cover hidden"></canvas>
                        <div id="camera-placeholder" class="w-full h-full flex items-center justify-center text-gray-500">
                            <div class="text-center">
                                <div class="text-4xl mb-2">ğŸ“·</div>
                                <div class="text-sm">Klik "Buka Kamera" untuk mulai</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col space-y-3">
                    <button id="start-camera-btn" onclick="startCamera()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        ğŸ“· Buka Kamera
                    </button>
                    <button id="take-photo-btn" onclick="takePhoto()" 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors hidden">
                        ğŸ“¸ Ambil Foto
                    </button>
                    <button id="retake-photo-btn" onclick="retakePhoto()" 
                            class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-colors hidden">
                        ğŸ”„ Foto Ulang
                    </button>
                    <button id="confirm-photo-btn" onclick="confirmPhoto()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors hidden">
                        âœ… Konfirmasi Absen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo View Modal -->
    <div id="photo-view-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800" id="view-modal-title">Foto Absensi</h3>
                    <button onclick="closePhotoViewModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                
                <div class="text-center mb-4">
                    <img id="view-photo-img" class="w-64 h-48 object-cover rounded-lg mx-auto" src="" alt="Foto Absensi">
                </div>
                
                <div class="text-center">
                    <button onclick="closePhotoViewModal()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Detail Modal -->
    <div id="student-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800" id="detail-student-name">Detail Kehadiran Siswa</h3>
                        <p class="text-gray-600" id="detail-student-info">NIS: -</p>
                    </div>
                    <button onclick="closeStudentDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-green-600" id="detail-hadir">0</div>
                        <div class="text-xs text-green-700">Hadir</div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-red-600" id="detail-tidak-hadir">0</div>
                        <div class="text-xs text-red-700">Tidak Hadir</div>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-yellow-600" id="detail-izin">0</div>
                        <div class="text-xs text-yellow-700">Izin</div>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-orange-600" id="detail-sakit">0</div>
                        <div class="text-xs text-orange-700">Sakit</div>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-purple-600" id="detail-percentage">0%</div>
                        <div class="text-xs text-purple-700">Kehadiran</div>
                    </div>
                </div>

                <!-- Attendance History Table -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300 rounded-lg">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-4 py-2 text-left font-semibold text-gray-700">Tanggal</th>
                                <th class="border border-gray-300 px-4 py-2 text-center font-semibold text-gray-700">Status</th>
                                <th class="border border-gray-300 px-4 py-2 text-center font-semibold text-gray-700">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody id="detail-attendance-table">
                            <!-- Detail attendance akan muncul di sini -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="closeStudentDetailModal()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let students = JSON.parse(localStorage.getItem('students')) || [];
        let attendanceHistory = JSON.parse(localStorage.getItem('attendanceHistory')) || [];
        let todayAttendance = {};
        let filteredHistory = [];
        
        // Photo modal variables
        let currentStudentId = null;
        let currentStudentName = '';
        let currentStream = null;
        let capturedPhoto = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Add default students if none exist
            if (students.length === 0) {
                addDefaultStudents();
            }
            updateCurrentDate();
            loadTodayAttendance();
            renderStudentList();
            renderAbsenList();
            updateStatistics();
            renderAttendanceHistory();
            updateFilterInfo();
        });

        // Add default student data
        function addDefaultStudents() {
            const defaultStudents = [
                { nis: '098', name: 'ADE RAHMA ALYA' },
                { nis: '099', name: 'ANASTASYA ARISKA F' },
                { nis: '100', name: 'ANIS AULIA' },
                { nis: '101', name: 'AQIILAH SALMA' },
                { nis: '102', name: 'AUDINA MIRELLA S' },
                { nis: '103', name: 'CHRISTIAN RIVALDO R H' },
                { nis: '104', name: 'DIRLY DARMAWAN' },
                { nis: '105', name: 'ERIDA CHRISTINA P' },
                { nis: '106', name: 'ERNA MUTIA FATANNAH' },
                { nis: '107', name: 'EVINA FITRIANI' },
                { nis: '108', name: 'FATTUR DEO PRAKAS' },
                { nis: '109', name: 'KAILA RIFA ANZANI' },
                { nis: '110', name: 'KAYLA PUTRI AURELLIA' },
                { nis: '111', name: 'KEISYA AYU SYAHRANI' },
                { nis: '112', name: 'M.BINTANG PAMUNGKAS' },
                { nis: '113', name: 'MAULANA DIMAS ADITYA' },
                { nis: '114', name: 'MAURA AMELIA PUTRI R' },
                { nis: '115', name: 'MEUTYA SALSHABILLA' },
                { nis: '116', name: 'MUHAMMAD FAHREL' },
                { nis: '117', name: 'M. RHASYAH ARYA PUTRA' },
                { nis: '118', name: 'NIKOLAS SAPUTRA' },
                { nis: '119', name: 'NOVITA ELVIANI' },
                { nis: '120', name: 'NUR FAHMI LAELA' },
                { nis: '121', name: 'NUR\'AINI SYARIFAH' },
                { nis: '122', name: 'NURILMAN ALHALUBI' },
                { nis: '123', name: 'RASYA HAIKAL AL GHIFARI' },
                { nis: '124', name: 'RICA AULIA AGUSTIN' },
                { nis: '125', name: 'RIMA ALVIAH YULISTIARA' },
                { nis: '126', name: 'RIZKI FEBRIYANI' },
                { nis: '127', name: 'ROBBY ARDIANSYAH' },
                { nis: '128', name: 'SALSABILLA' },
                { nis: '129', name: 'SYIFA NURAINI' },
                { nis: '130', name: 'TALITA AULIA ANANDA' },
                { nis: '131', name: 'TITA AULIA' },
                { nis: '132', name: 'YUSUF RAMADHAN' },
                { nis: '133', name: 'ZAKI HIBBATUL WAFI' },
                { nis: '134', name: 'ZALFA LINGGA SAPUTRA' },
                { nis: '135', name: 'ZARQA SHAFIKA KAILA' }
            ];

            defaultStudents.forEach((studentData, index) => {
                const newStudent = {
                    id: Date.now() + index,
                    name: studentData.name,
                    studentId: studentData.nis,
                    dateAdded: new Date().toISOString()
                };
                students.push(newStudent);
            });

            localStorage.setItem('students', JSON.stringify(students));
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('text-gray-600');
            });
            
            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('bg-blue-500', 'text-white');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600');
            
            // Update data when switching tabs
            if (tabName === 'laporan') {
                updateStatistics();
                renderAttendanceHistory();
            } else if (tabName === 'rekap') {
                renderStudentRecap();
            }
        }

        // Date management
        function updateCurrentDate() {
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('current-date').textContent = today.toLocaleDateString('id-ID', options);
        }

        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        // Student management
        function addStudent(event) {
            event.preventDefault();
            
            const name = document.getElementById('student-name').value.trim();
            const studentId = document.getElementById('student-id').value.trim();
            
            if (!name) return;
            
            const newStudent = {
                id: Date.now(),
                name: name,
                studentId: studentId || `S${students.length + 1}`,
                dateAdded: new Date().toISOString()
            };
            
            students.push(newStudent);
            localStorage.setItem('students', JSON.stringify(students));
            
            // Reset form
            document.getElementById('student-name').value = '';
            document.getElementById('student-id').value = '';
            
            renderStudentList();
            renderAbsenList();
            updateStatistics();
        }

        function removeStudent(studentId) {
            if (confirm('Yakin ingin menghapus siswa ini?')) {
                students = students.filter(s => s.id !== studentId);
                localStorage.setItem('students', JSON.stringify(students));
                
                renderStudentList();
                renderAbsenList();
                updateStatistics();
            }
        }

        function renderStudentList() {
            const container = document.getElementById('student-list');
            
            if (students.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada siswa. Tambahkan siswa baru di atas.</p>';
                return;
            }
            
            container.innerHTML = students.map(student => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                        <div class="font-medium text-gray-800">${student.name}</div>
                        <div class="text-sm text-gray-500">NIS: ${student.studentId}</div>
                    </div>
                    <button onclick="removeStudent(${student.id})" 
                            class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-colors">
                        ğŸ—‘ï¸
                    </button>
                </div>
            `).join('');
        }

        // Attendance management
        function loadTodayAttendance() {
            const today = getTodayString();
            const todayRecord = attendanceHistory.find(record => record.date === today);
            
            if (todayRecord) {
                todayAttendance = { ...todayRecord.attendance };
            } else {
                todayAttendance = {};
            }
        }

        function renderAbsenList() {
            const container = document.getElementById('absen-list');
            
            if (students.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada siswa untuk diabsen. Tambahkan siswa terlebih dahulu.</p>';
                return;
            }
            
            container.innerHTML = students.map(student => {
                const status = todayAttendance[student.id] || 'belum';
                return `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <span class="text-blue-600 font-semibold">${student.name.charAt(0)}</span>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">${student.name}</div>
                                <div class="text-sm text-gray-500">NIS: ${student.studentId}</div>
                            </div>
                        </div>
                        <div class="flex space-x-2 flex-wrap">
                            <button onclick="openPhotoModal(${student.id}, '${student.name.replace(/'/g, "\\'")}', 'hadir')" 
                                    class="px-4 py-2 rounded-lg font-medium transition-colors ${status === 'hadir' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-green-100'} flex items-center space-x-1">
                                <span>ğŸ“¸</span>
                                <span>Hadir</span>
                            </button>
                            <button onclick="markAttendance(${student.id}, 'tidak-hadir')" 
                                    class="px-4 py-2 rounded-lg font-medium transition-colors ${status === 'tidak-hadir' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-red-100'}">
                                âŒ Tidak Hadir
                            </button>
                            <button onclick="markAttendance(${student.id}, 'izin')" 
                                    class="px-4 py-2 rounded-lg font-medium transition-colors ${status === 'izin' ? 'bg-yellow-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-yellow-100'}">
                                ğŸ“ Izin
                            </button>
                            <button onclick="markAttendance(${student.id}, 'sakit')" 
                                    class="px-4 py-2 rounded-lg font-medium transition-colors ${status === 'sakit' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-orange-100'}">
                                ğŸ¤’ Sakit
                            </button>
                            ${status === 'hadir' && todayAttendance[student.id + '_photo'] ? `
                                <button onclick="viewPhoto(${student.id})" 
                                        class="px-3 py-2 rounded-lg font-medium bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors text-sm">
                                    ğŸ‘ï¸ Lihat Foto
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function markAttendance(studentId, status) {
            todayAttendance[studentId] = status;
            renderAbsenList();
            updateStatistics();
        }

        function markAllPresent() {
            students.forEach(student => {
                todayAttendance[student.id] = 'hadir';
            });
            renderAbsenList();
            updateStatistics();
        }

        function saveAttendance() {
            const today = getTodayString();
            
            // Remove existing record for today
            attendanceHistory = attendanceHistory.filter(record => record.date !== today);
            
            // Add new record
            attendanceHistory.push({
                date: today,
                attendance: { ...todayAttendance },
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem('attendanceHistory', JSON.stringify(attendanceHistory));
            
            alert('âœ… Absensi berhasil disimpan!');
            updateStatistics();
            renderAttendanceHistory();
        }

        // Statistics and reporting
        function updateStatistics() {
            const totalStudents = students.length;
            const presentCount = Object.values(todayAttendance).filter(status => status === 'hadir').length;
            const absentCount = Object.values(todayAttendance).filter(status => status === 'tidak-hadir').length;
            const izinCount = Object.values(todayAttendance).filter(status => status === 'izin').length;
            const sakitCount = Object.values(todayAttendance).filter(status => status === 'sakit').length;
            
            document.getElementById('total-students').textContent = totalStudents;
            document.getElementById('total-present').textContent = presentCount;
            document.getElementById('total-absent').textContent = absentCount;
            document.getElementById('total-izin').textContent = izinCount;
            document.getElementById('total-sakit').textContent = sakitCount;
        }

        function renderAttendanceHistory() {
            const container = document.getElementById('attendance-history');
            const dataToShow = filteredHistory.length > 0 ? filteredHistory : attendanceHistory;
            
            if (dataToShow.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Tidak ada data yang sesuai dengan filter.</p>';
                return;
            }
            
            const sortedHistory = dataToShow.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedHistory.map(record => {
                const date = new Date(record.date).toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const presentCount = Object.values(record.attendance).filter(status => status === 'hadir').length;
                const absentCount = Object.values(record.attendance).filter(status => status === 'tidak-hadir').length;
                const izinCount = Object.values(record.attendance).filter(status => status === 'izin').length;
                const sakitCount = Object.values(record.attendance).filter(status => status === 'sakit').length;
                const totalStudents = Object.keys(record.attendance).length;
                
                return `
                    <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <div class="font-medium text-gray-800">${date}</div>
                                <div class="text-sm text-gray-500">
                                    Total: ${totalStudents} siswa
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="flex flex-wrap gap-2 text-sm">
                                    <span class="text-green-600">âœ… ${presentCount} Hadir</span>
                                    <span class="text-red-600">âŒ ${absentCount} Tidak Hadir</span>
                                    <span class="text-yellow-600">ğŸ“ ${izinCount} Izin</span>
                                    <span class="text-orange-600">ğŸ¤’ ${sakitCount} Sakit</span>
                                </div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: ${totalStudents > 0 ? (presentCount / totalStudents) * 100 : 0}%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Tingkat kehadiran: ${totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0}%
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter functions
        function applyFilter() {
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const status = document.getElementById('filter-status').value;
            
            filteredHistory = attendanceHistory.filter(record => {
                let matchDate = true;
                let matchStatus = true;
                
                // Filter by date range
                if (startDate && endDate) {
                    const recordDate = new Date(record.date);
                    const filterStart = new Date(startDate);
                    const filterEnd = new Date(endDate);
                    matchDate = recordDate >= filterStart && recordDate <= filterEnd;
                } else if (startDate) {
                    const recordDate = new Date(record.date);
                    const filterStart = new Date(startDate);
                    matchDate = recordDate >= filterStart;
                } else if (endDate) {
                    const recordDate = new Date(record.date);
                    const filterEnd = new Date(endDate);
                    matchDate = recordDate <= filterEnd;
                }
                
                // Filter by status (check if any student has the selected status)
                if (status) {
                    matchStatus = Object.values(record.attendance).includes(status);
                }
                
                return matchDate && matchStatus;
            });
            
            updateFilterInfo();
            renderAttendanceHistory();
        }

        function resetFilter() {
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            document.getElementById('filter-status').value = '';
            
            filteredHistory = [];
            updateFilterInfo();
            renderAttendanceHistory();
        }

        function updateFilterInfo() {
            const infoElement = document.getElementById('filter-info');
            const dataCount = filteredHistory.length > 0 ? filteredHistory.length : attendanceHistory.length;
            const totalCount = attendanceHistory.length;
            
            if (filteredHistory.length > 0) {
                infoElement.textContent = `Menampilkan ${dataCount} dari ${totalCount} data`;
            } else {
                infoElement.textContent = `Menampilkan semua data (${totalCount})`;
            }
        }

        // Export functions
        function exportToExcel(type) {
            const dataToExport = type === 'filtered' && filteredHistory.length > 0 ? filteredHistory : attendanceHistory;
            
            if (dataToExport.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }

            // Create CSV content
            let csvContent = 'Tanggal,Nama Siswa,NIS,Status Kehadiran\n';
            
            dataToExport.forEach(record => {
                const date = new Date(record.date).toLocaleDateString('id-ID');
                
                Object.entries(record.attendance).forEach(([studentId, status]) => {
                    const student = students.find(s => s.id == studentId);
                    if (student) {
                        const statusText = status === 'hadir' ? 'Hadir' : 
                                         status === 'tidak-hadir' ? 'Tidak Hadir' : 
                                         status === 'izin' ? 'Izin' : 'Sakit';
                        csvContent += `"${date}","${student.name}","${student.studentId}","${statusText}"\n`;
                    }
                });
            });

            downloadCSV(csvContent, `Rekap_Absensi_${type === 'filtered' ? 'Terfilter' : 'Lengkap'}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportStudentList() {
            if (students.length === 0) {
                alert('Tidak ada data siswa untuk diekspor!');
                return;
            }

            let csvContent = 'No,Nama Siswa,NIS,Tanggal Ditambahkan\n';
            
            students.forEach((student, index) => {
                const dateAdded = new Date(student.dateAdded).toLocaleDateString('id-ID');
                csvContent += `${index + 1},"${student.name}","${student.studentId}","${dateAdded}"\n`;
            });

            downloadCSV(csvContent, `Daftar_Siswa_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportSummaryReport() {
            if (attendanceHistory.length === 0) {
                alert('Tidak ada data absensi untuk membuat laporan ringkasan!');
                return;
            }

            let csvContent = 'Tanggal,Total Siswa,Hadir,Tidak Hadir,Izin,Sakit,Persentase Kehadiran\n';
            
            const dataToProcess = filteredHistory.length > 0 ? filteredHistory : attendanceHistory;
            
            dataToProcess.forEach(record => {
                const date = new Date(record.date).toLocaleDateString('id-ID');
                const presentCount = Object.values(record.attendance).filter(status => status === 'hadir').length;
                const absentCount = Object.values(record.attendance).filter(status => status === 'tidak-hadir').length;
                const izinCount = Object.values(record.attendance).filter(status => status === 'izin').length;
                const sakitCount = Object.values(record.attendance).filter(status => status === 'sakit').length;
                const totalStudents = Object.keys(record.attendance).length;
                const percentage = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;
                
                csvContent += `"${date}",${totalStudents},${presentCount},${absentCount},${izinCount},${sakitCount},${percentage}%\n`;
            });

            // Add summary statistics
            csvContent += '\n\nRINGKASAN STATISTIK\n';
            csvContent += 'Metrik,Nilai\n';
            
            const totalDays = dataToProcess.length;
            const totalPresent = dataToProcess.reduce((sum, record) => 
                sum + Object.values(record.attendance).filter(status => status === 'hadir').length, 0);
            const totalAbsent = dataToProcess.reduce((sum, record) => 
                sum + Object.values(record.attendance).filter(status => status === 'tidak-hadir').length, 0);
            const totalIzin = dataToProcess.reduce((sum, record) => 
                sum + Object.values(record.attendance).filter(status => status === 'izin').length, 0);
            const totalSakit = dataToProcess.reduce((sum, record) => 
                sum + Object.values(record.attendance).filter(status => status === 'sakit').length, 0);
            const avgAttendance = totalDays > 0 ? Math.round((totalPresent / (totalPresent + totalAbsent + totalIzin + totalSakit)) * 100) : 0;
            
            csvContent += `"Total Hari Absensi",${totalDays}\n`;
            csvContent += `"Total Kehadiran",${totalPresent}\n`;
            csvContent += `"Total Ketidakhadiran",${totalAbsent}\n`;
            csvContent += `"Total Izin",${totalIzin}\n`;
            csvContent += `"Total Sakit",${totalSakit}\n`;
            csvContent += `"Rata-rata Kehadiran",${avgAttendance}%\n`;
            csvContent += `"Total Siswa Terdaftar",${students.length}\n`;

            downloadCSV(csvContent, `Laporan_Ringkasan_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Photo functions
        function openPhotoModal(studentId, studentName, status) {
            currentStudentId = studentId;
            currentStudentName = studentName;
            
            document.getElementById('modal-title').textContent = `Absen Foto - ${studentName}`;
            document.getElementById('photo-modal').classList.remove('hidden');
            
            // Reset modal state
            resetModalState();
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').classList.add('hidden');
            stopCamera();
            resetModalState();
        }

        function resetModalState() {
            // Hide all buttons except start camera
            document.getElementById('start-camera-btn').classList.remove('hidden');
            document.getElementById('take-photo-btn').classList.add('hidden');
            document.getElementById('retake-photo-btn').classList.add('hidden');
            document.getElementById('confirm-photo-btn').classList.add('hidden');
            
            // Show placeholder, hide video and canvas
            document.getElementById('camera-placeholder').classList.remove('hidden');
            document.getElementById('camera-video').classList.add('hidden');
            document.getElementById('photo-canvas').classList.add('hidden');
            
            capturedPhoto = null;
        }

        async function startCamera() {
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                });
                
                const video = document.getElementById('camera-video');
                video.srcObject = currentStream;
                
                // Show video, hide placeholder
                document.getElementById('camera-placeholder').classList.add('hidden');
                video.classList.remove('hidden');
                
                // Update buttons
                document.getElementById('start-camera-btn').classList.add('hidden');
                document.getElementById('take-photo-btn').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Tidak dapat mengakses kamera. Pastikan browser memiliki izin kamera.');
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function takePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('photo-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            ctx.drawImage(video, 0, 0);
            
            // Convert to base64
            capturedPhoto = canvas.toDataURL('image/jpeg', 0.8);
            
            // Show canvas, hide video
            video.classList.add('hidden');
            canvas.classList.remove('hidden');
            
            // Update buttons
            document.getElementById('take-photo-btn').classList.add('hidden');
            document.getElementById('retake-photo-btn').classList.remove('hidden');
            document.getElementById('confirm-photo-btn').classList.remove('hidden');
            
            // Stop camera
            stopCamera();
        }

        function retakePhoto() {
            // Hide canvas, show placeholder
            document.getElementById('photo-canvas').classList.add('hidden');
            document.getElementById('camera-placeholder').classList.remove('hidden');
            
            // Reset buttons
            document.getElementById('retake-photo-btn').classList.add('hidden');
            document.getElementById('confirm-photo-btn').classList.add('hidden');
            document.getElementById('start-camera-btn').classList.remove('hidden');
            
            capturedPhoto = null;
        }

        function confirmPhoto() {
            if (capturedPhoto && currentStudentId) {
                // Mark attendance with photo
                todayAttendance[currentStudentId] = 'hadir';
                todayAttendance[currentStudentId + '_photo'] = capturedPhoto;
                todayAttendance[currentStudentId + '_photo_time'] = new Date().toISOString();
                
                // Download photo to simulate saving to folder structure
                downloadPhoto(capturedPhoto, currentStudentName, currentStudentId);
                
                // Close modal and refresh list
                closePhotoModal();
                renderAbsenList();
                updateStatistics();
                
                // Show success message
                showToast(`âœ… Absensi foto ${currentStudentName} berhasil disimpan!`);
            }
        }

        function downloadPhoto(photoData, studentName, studentId) {
            // Create folder structure simulation: Absen/YYYY-MM-DD/
            const today = new Date();
            const dateFolder = today.toISOString().split('T')[0]; // YYYY-MM-DD format
            const timeStamp = today.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS format
            
            // Create filename with student info and timestamp
            const filename = `${studentId}_${studentName.replace(/[^a-zA-Z0-9]/g, '_')}_${timeStamp}.jpg`;
            const folderPath = `Absen/${dateFolder}`;
            
            // Convert base64 to blob
            const byteCharacters = atob(photoData.split(',')[1]);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/jpeg' });
            
            // Create download link
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Show folder structure info
            console.log(`ğŸ“ Foto disimpan ke: ${folderPath}/${filename}`);
            
            // Store folder info for display
            if (!todayAttendance['_folder_info']) {
                todayAttendance['_folder_info'] = folderPath;
            }
        }

        function viewPhoto(studentId) {
            const photoData = todayAttendance[studentId + '_photo'];
            const student = students.find(s => s.id === studentId);
            
            if (photoData && student) {
                document.getElementById('view-modal-title').textContent = `Foto Absensi - ${student.name}`;
                document.getElementById('view-photo-img').src = photoData;
                document.getElementById('photo-view-modal').classList.remove('hidden');
            }
        }

        function closePhotoViewModal() {
            document.getElementById('photo-view-modal').classList.add('hidden');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 3000);
        }

        // Student Recap Functions
        function renderStudentRecap() {
            const container = document.getElementById('student-recap-table');
            const startDate = document.getElementById('recap-start-date').value;
            const endDate = document.getElementById('recap-end-date').value;
            
            // Filter attendance history by date range
            let filteredData = attendanceHistory;
            if (startDate || endDate) {
                filteredData = attendanceHistory.filter(record => {
                    const recordDate = new Date(record.date);
                    let matchDate = true;
                    
                    if (startDate && endDate) {
                        const filterStart = new Date(startDate);
                        const filterEnd = new Date(endDate);
                        matchDate = recordDate >= filterStart && recordDate <= filterEnd;
                    } else if (startDate) {
                        const filterStart = new Date(startDate);
                        matchDate = recordDate >= filterStart;
                    } else if (endDate) {
                        const filterEnd = new Date(endDate);
                        matchDate = recordDate <= filterEnd;
                    }
                    
                    return matchDate;
                });
            }
            
            if (students.length === 0) {
                container.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">Belum ada data siswa.</td></tr>';
                updateRecapSummary([], 0);
                return;
            }
            
            // Calculate recap for each student
            const studentRecaps = students.map((student, index) => {
                let hadir = 0, tidakHadir = 0, izin = 0, sakit = 0;
                
                filteredData.forEach(record => {
                    const status = record.attendance[student.id];
                    if (status === 'hadir') hadir++;
                    else if (status === 'tidak-hadir') tidakHadir++;
                    else if (status === 'izin') izin++;
                    else if (status === 'sakit') sakit++;
                });
                
                const totalDays = hadir + tidakHadir + izin + sakit;
                const percentage = totalDays > 0 ? Math.round((hadir / totalDays) * 100) : 0;
                
                return {
                    ...student,
                    index: index + 1,
                    hadir,
                    tidakHadir,
                    izin,
                    sakit,
                    totalDays,
                    percentage
                };
            });
            
            // Sort by attendance percentage (descending)
            studentRecaps.sort((a, b) => b.percentage - a.percentage);
            
            container.innerHTML = studentRecaps.map(student => {
                const percentageColor = student.percentage >= 90 ? 'text-green-600' : 
                                      student.percentage >= 75 ? 'text-yellow-600' : 'text-red-600';
                
                return `
                    <tr class="hover:bg-gray-50 ${student.percentage < 75 ? 'bg-red-50' : ''}">
                        <td class="border border-gray-300 px-4 py-2 text-center">${student.index}</td>
                        <td class="border border-gray-300 px-4 py-2 font-medium">${student.studentId}</td>
                        <td class="border border-gray-300 px-4 py-2 font-medium">${student.name}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-green-600 font-semibold">${student.hadir}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-red-600 font-semibold">${student.tidakHadir}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-yellow-600 font-semibold">${student.izin}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-orange-600 font-semibold">${student.sakit}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-blue-600 font-semibold">${student.totalDays}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center font-bold ${percentageColor}">${student.percentage}%</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <button onclick="showStudentDetail(${student.id})" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ğŸ“‹ Detail
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateRecapSummary(studentRecaps, filteredData.length);
        }

        function updateRecapSummary(studentRecaps, totalDays) {
            if (studentRecaps.length === 0) {
                document.getElementById('avg-attendance').textContent = '0%';
                document.getElementById('total-days-recap').textContent = '0';
                document.getElementById('best-attendance').textContent = '-';
                document.getElementById('needs-attention').textContent = '0';
                return;
            }
            
            const avgAttendance = Math.round(studentRecaps.reduce((sum, s) => sum + s.percentage, 0) / studentRecaps.length);
            const bestStudent = studentRecaps[0];
            const needsAttention = studentRecaps.filter(s => s.percentage < 75).length;
            
            document.getElementById('avg-attendance').textContent = avgAttendance + '%';
            document.getElementById('total-days-recap').textContent = totalDays;
            document.getElementById('best-attendance').textContent = bestStudent ? `${bestStudent.name} (${bestStudent.percentage}%)` : '-';
            document.getElementById('needs-attention').textContent = needsAttention;
        }

        function applyRecapFilter() {
            renderStudentRecap();
        }

        function refreshStudentRecap() {
            document.getElementById('recap-start-date').value = '';
            document.getElementById('recap-end-date').value = '';
            document.getElementById('student-search').value = '';
            renderStudentRecap();
        }

        function searchStudent() {
            const searchTerm = document.getElementById('student-search').value.toLowerCase();
            const rows = document.querySelectorAll('#student-recap-table tr');
            
            rows.forEach(row => {
                const studentName = row.cells[2]?.textContent.toLowerCase() || '';
                const studentNis = row.cells[1]?.textContent.toLowerCase() || '';
                
                if (studentName.includes(searchTerm) || studentNis.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function showStudentDetail(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Set modal title
            document.getElementById('detail-student-name').textContent = student.name;
            document.getElementById('detail-student-info').textContent = `NIS: ${student.studentId}`;
            
            // Calculate student statistics
            let hadir = 0, tidakHadir = 0, izin = 0, sakit = 0;
            const studentHistory = [];
            
            attendanceHistory.forEach(record => {
                const status = record.attendance[studentId];
                if (status) {
                    if (status === 'hadir') hadir++;
                    else if (status === 'tidak-hadir') tidakHadir++;
                    else if (status === 'izin') izin++;
                    else if (status === 'sakit') sakit++;
                    
                    studentHistory.push({
                        date: record.date,
                        status: status,
                        hasPhoto: !!record.attendance[studentId + '_photo']
                    });
                }
            });
            
            const totalDays = hadir + tidakHadir + izin + sakit;
            const percentage = totalDays > 0 ? Math.round((hadir / totalDays) * 100) : 0;
            
            // Update summary cards
            document.getElementById('detail-hadir').textContent = hadir;
            document.getElementById('detail-tidak-hadir').textContent = tidakHadir;
            document.getElementById('detail-izin').textContent = izin;
            document.getElementById('detail-sakit').textContent = sakit;
            document.getElementById('detail-percentage').textContent = percentage + '%';
            
            // Render attendance history table
            const tableBody = document.getElementById('detail-attendance-table');
            studentHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tableBody.innerHTML = studentHistory.map(record => {
                const date = new Date(record.date).toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const statusText = record.status === 'hadir' ? 'âœ… Hadir' :
                                 record.status === 'tidak-hadir' ? 'âŒ Tidak Hadir' :
                                 record.status === 'izin' ? 'ğŸ“ Izin' : 'ğŸ¤’ Sakit';
                
                const statusColor = record.status === 'hadir' ? 'text-green-600' :
                                  record.status === 'tidak-hadir' ? 'text-red-600' :
                                  record.status === 'izin' ? 'text-yellow-600' : 'text-orange-600';
                
                const keterangan = record.status === 'hadir' && record.hasPhoto ? 'Dengan foto' : '-';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-2">${date}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center font-semibold ${statusColor}">${statusText}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-sm text-gray-600">${keterangan}</td>
                    </tr>
                `;
            }).join('');
            
            if (studentHistory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Belum ada data kehadiran</td></tr>';
            }
            
            // Show modal
            document.getElementById('student-detail-modal').classList.remove('hidden');
        }

        function closeStudentDetailModal() {
            document.getElementById('student-detail-modal').classList.add('hidden');
        }

        function exportStudentRecap() {
            if (students.length === 0) {
                alert('Tidak ada data siswa untuk diekspor!');
                return;
            }

            const startDate = document.getElementById('recap-start-date').value;
            const endDate = document.getElementById('recap-end-date').value;
            
            // Filter attendance history by date range
            let filteredData = attendanceHistory;
            if (startDate || endDate) {
                filteredData = attendanceHistory.filter(record => {
                    const recordDate = new Date(record.date);
                    let matchDate = true;
                    
                    if (startDate && endDate) {
                        const filterStart = new Date(startDate);
                        const filterEnd = new Date(endDate);
                        matchDate = recordDate >= filterStart && recordDate <= filterEnd;
                    } else if (startDate) {
                        const filterStart = new Date(startDate);
                        matchDate = recordDate >= filterStart;
                    } else if (endDate) {
                        const filterEnd = new Date(endDate);
                        matchDate = recordDate <= filterEnd;
                    }
                    
                    return matchDate;
                });
            }

            let csvContent = 'No,NIS,Nama Siswa,Hadir,Tidak Hadir,Izin,Sakit,Total Hari,Persentase Kehadiran\n';
            
            students.forEach((student, index) => {
                let hadir = 0, tidakHadir = 0, izin = 0, sakit = 0;
                
                filteredData.forEach(record => {
                    const status = record.attendance[student.id];
                    if (status === 'hadir') hadir++;
                    else if (status === 'tidak-hadir') tidakHadir++;
                    else if (status === 'izin') izin++;
                    else if (status === 'sakit') sakit++;
                });
                
                const totalDays = hadir + tidakHadir + izin + sakit;
                const percentage = totalDays > 0 ? Math.round((hadir / totalDays) * 100) : 0;
                
                csvContent += `${index + 1},"${student.studentId}","${student.name}",${hadir},${tidakHadir},${izin},${sakit},${totalDays},${percentage}%\n`;
            });

            const periodText = startDate && endDate ? `_${startDate}_sampai_${endDate}` : 
                              startDate ? `_dari_${startDate}` : 
                              endDate ? `_sampai_${endDate}` : '';
            
            downloadCSV(csvContent, `Rekap_Kehadiran_Siswa${periodText}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csvContent, filename) {
            // Add BOM for proper UTF-8 encoding in Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = `âœ… File ${filename} berhasil diunduh!`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9816fc3d875f0d7e',t:'MTc1ODI2MjkxMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
