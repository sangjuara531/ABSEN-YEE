<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Program Absen Kelas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        @keyframes pulse-success {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        .pulse-success {
            animation: pulse-success 0.6s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ“š Program Absen Kelas</h1>
            <p class="text-gray-600">Kelola kehadiran siswa dengan mudah</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-8">
            <div class="bg-white rounded-lg p-1 shadow-lg">
                <button onclick="showTab('absen')" id="tab-absen" class="px-6 py-3 rounded-md font-medium transition-all bg-blue-500 text-white">
                    âœ… Absen Hari Ini
                </button>
                <button onclick="showTab('siswa')" id="tab-siswa" class="px-6 py-3 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500">
                    ğŸ‘¥ Kelola Siswa
                </button>
                <button onclick="showTab('rekap')" id="tab-rekap" class="px-6 py-3 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500">
                    ğŸ“‹ Rekap Siswa
                </button>
                <button onclick="showTab('laporan')" id="tab-laporan" class="px-6 py-3 rounded-md font-medium transition-all text-gray-600 hover:text-blue-500">
                    ğŸ“Š Laporan
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Absen Tab -->
            <div id="content-absen" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Absensi Hari Ini</h2>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Tanggal</p>
                            <p class="font-semibold text-gray-800" id="current-date"></p>
                        </div>
                    </div>
                    
                    <div id="absen-list" class="space-y-3">
                        <!-- Daftar siswa untuk absen akan muncul di sini -->
                    </div>
                    
                    <div class="mt-6 flex flex-wrap justify-between gap-3">
                        <button onclick="markAllPresent()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            âœ… Tandai Semua Hadir
                        </button>
                        <div class="flex gap-3">
                            <button onclick="saveAttendance()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                ğŸ’¾ Simpan Absensi
                            </button>
                            <button onclick="sendToSpreadsheet()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <span>ğŸ“Š</span>
                                <span>Kirim ke Spreadsheet</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kelola Siswa Tab -->
            <div id="content-siswa" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Kelola Data Siswa</h2>
                    
                    <!-- Form Tambah Siswa -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-gray-700 mb-3">Tambah Siswa Baru</h3>
                        <form onsubmit="addStudent(event)" class="flex gap-3">
                            <input type="text" id="student-name" placeholder="Nama Siswa" required 
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <input type="text" id="student-id" placeholder="NIS (Opsional)" 
                                   class="w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                â• Tambah
                            </button>
                        </form>
                    </div>

                    <!-- Daftar Siswa -->
                    <div id="student-list" class="space-y-2">
                        <!-- Daftar siswa akan muncul di sini -->
                    </div>
                </div>
            </div>

            <!-- Rekap Siswa Tab -->
            <div id="content-rekap" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Rekap Kehadiran Per Siswa</h2>
                        <div class="flex space-x-3">
                            <button onclick="exportStudentRecap()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <span>ğŸ“Š</span>
                                <span>Ekspor Rekap</span>
                            </button>
                            <button onclick="refreshStudentRecap()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                ğŸ”„ Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Filter Periode -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-gray-700 mb-3">Filter Periode Rekap</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Dari Tanggal</label>
                                <input type="date" id="recap-start-date" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Sampai Tanggal</label>
                                <input type="date" id="recap-end-date" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div class="flex items-end">
                                <button onclick="applyRecapFilter()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors w-full">
                                    ğŸ” Terapkan Filter
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Search Box -->
                    <div class="mb-4">
                        <input type="text" id="student-search" placeholder="ğŸ” Cari nama siswa..." 
                               onkeyup="searchStudent()" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <!-- Rekap Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 rounded-lg">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">No</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">NIS</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-700">Nama Siswa</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-green-700">âœ… Hadir</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-red-700">âŒ Tidak Hadir</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-yellow-700">ğŸ“ Izin</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-orange-700">ğŸ¤’ Sakit</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-blue-700">ğŸ“Š Total Hari</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-purple-700">ğŸ“ˆ % Kehadiran</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700">ğŸ“‹ Detail</th>
                                </tr>
                            </thead>
                            <tbody id="student-recap-table">
                                <!-- Data rekap akan muncul di sini -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary Statistics -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600" id="avg-attendance">0%</div>
                            <div class="text-sm text-green-700">Rata-rata Kehadiran Kelas</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="total-days-recap">0</div>
                            <div class="text-sm text-blue-700">Total Hari Absensi</div>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600" id="best-attendance">-</div>
                            <div class="text-sm text-purple-700">Kehadiran Terbaik</div>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-600" id="needs-attention">0</div>
                            <div class="text-sm text-orange-700">Perlu Perhatian (&lt;75%)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Laporan Tab -->
            <div id="content-laporan" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Laporan Kehadiran</h2>
                    
                    <!-- Statistik -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600" id="total-present">0</div>
                            <div class="text-sm text-green-700">Total Hadir</div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-red-600" id="total-absent">0</div>
                            <div class="text-sm text-red-700">Total Tidak Hadir</div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="total-izin">0</div>
                            <div class="text-sm text-yellow-700">Total Izin</div>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-600" id="total-sakit">0</div>
                            <div class="text-sm text-orange-700">Total Sakit</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="total-students">0</div>
                            <div class="text-sm text-blue-700">Total Siswa</div>
                        </div>
                    </div>

                    <!-- Filter Controls -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-gray-700 mb-3">Filter Rekap</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Dari Tanggal</label>
                                <input type="date" id="filter-start-date" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Sampai Tanggal</label>
                                <input type="date" id="filter-end-date" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Status</label>
                                <select id="filter-status" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Semua Status</option>
                                    <option value="hadir">Hadir</option>
                                    <option value="tidak-hadir">Tidak Hadir</option>
                                    <option value="izin">Izin</option>
                                    <option value="sakit">Sakit</option>
                                </select>
                            </div>
                            <div class="flex items-end space-x-2">
                                <button onclick="applyFilter()" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                    ğŸ” Filter
                                </button>
                                <button onclick="resetFilter()" 
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                    ğŸ”„ Reset
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Export Controls -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 class="font-semibold text-blue-700 mb-3">ğŸ“Š Ekspor Data</h3>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="exportToExcel('all')" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <span>ğŸ“‹</span>
                                <span>Ekspor Semua Data</span>
                            </button>
                            <button onclick="exportToExcel('filtered')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <span>ğŸ”</span>
                                <span>Ekspor Data Terfilter</span>
                            </button>
                            <button onclick="exportStudentList()" 
                                    class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <span>ğŸ‘¥</span>
                                <span>Ekspor Daftar Siswa</span>
                            </button>
                            <button onclick="exportSummaryReport()" 
                                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <span>ğŸ“ˆ</span>
                                <span>Ekspor Laporan Ringkasan</span>
                            </button>
                        </div>
                    </div>

                    <!-- Riwayat Absensi -->
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-gray-700">Riwayat Absensi</h3>
                            <div class="text-sm text-gray-500" id="filter-info">
                                Menampilkan semua data
                            </div>
                        </div>
                        <div id="attendance-history" class="space-y-2">
                            <!-- Riwayat akan muncul di sini -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photo-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800" id="modal-title">Absen Foto</h3>
                    <button onclick="closePhotoModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                
                <div class="text-center mb-4">
                    <div class="w-64 h-48 bg-gray-100 rounded-lg mx-auto mb-4 overflow-hidden" id="camera-container">
                        <video id="camera-video" class="w-full h-full object-cover hidden" autoplay playsinline></video>
                        <canvas id="photo-canvas" class="w-full h-full object-cover hidden"></canvas>
                        <div id="camera-placeholder" class="w-full h-full flex items-center justify-center text-gray-500">
                            <div class="text-center">
                                <div class="text-4xl mb-2">ğŸ“·</div>
                                <div class="text-sm">Klik "Buka Kamera" untuk mulai</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col space-y-3">
                    <button id="start-camera-btn" onclick="startCamera()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        ğŸ“· Buka Kamera
                    </button>
                    <button id="take-photo-btn" onclick="takePhoto()" 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors hidden">
                        ğŸ“¸ Ambil Foto
                    </button>
                    <button id="retake-photo-btn" onclick="retakePhoto()" 
                            class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-colors hidden">
                        ğŸ”„ Foto Ulang
                    </button>
                    <button id="confirm-photo-btn" onclick="confirmPhoto()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors hidden">
                        âœ… Konfirmasi Absen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo View Modal -->
    <div id="photo-view-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800" id="view-modal-title">Foto Absensi</h3>
                    <button onclick="closePhotoViewModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                
                <div class="text-center mb-4">
                    <img id="view-photo-img" class="w-64 h-48 object-cover rounded-lg mx-auto" src="" alt="Foto Absensi">
                </div>
                
                <div class="text-center">
                    <button onclick="closePhotoViewModal()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Detail Modal -->
    <div id="student-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800" id="detail-student-name">Detail Kehadiran Siswa</h3>
                        <p class="text-gray-600" id="detail-student-info">NIS: -</p>
                    </div>
                    <button onclick="closeStudentDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-green-600" id="detail-hadir">0</div>
                        <div class="text-xs text-green-700">Hadir</div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-red-600" id="detail-tidak-hadir">0</div>
                        <div class="text-xs text-red-700">Tidak Hadir</div>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-yellow-600" id="detail-izin">0</div>
                        <div class="text-xs text-yellow-700">Izin</div>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-orange-600" id="detail-sakit">0</div>
                        <div class="text-xs text-orange-700">Sakit</div>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 text-center">
                        <div class="text-xl font-bold text-purple-600" id="detail-percentage">0%</div>
                        <div class="text-xs text-purple-700">Kehadiran</div>
                    </div>
                </div>

                <!-- Attendance History Table -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300 rounded-lg">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border border-gray-300 px-4 py-2 text-left font-semibold text-gray-700">Tanggal</th>
                                <th class="border border-gray-300 px-4 py-2 text-center font-semibold text-gray-700">Status</th>
                                <th class="border border-gray-300 px-4 py-2 text-center font-semibold text-gray-700">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody id="detail-attendance-table">
                            <!-- Detail attendance akan muncul di sini -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="closeStudentDetailModal()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let students = JSON.parse(localStorage.getItem('students')) || [];
        let attendanceHistory = JSON.parse(localStorage.getItem('attendanceHistory')) || [];
        let todayAttendance = {};
        let filteredHistory = [];
        
        // Photo modal variables
        let currentStudentId = null;
        let currentStudentName = '';
        let currentStream = null;
        let capturedPhoto = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Add default students if none exist
            if (students.length === 0) {
                addDefaultStudents();
            }
            updateCurrentDate();
            loadTodayAttendance();
            renderStudentList();
            renderAbsenList();
            updateStatistics();
            renderAttendanceHistory();
            updateFilterInfo();
        });

        // Add default student data
        function addDefaultStudents() {
            const defaultStudents = [
                { nis: '098', name: 'ADE RAHMA ALYA' },
                { nis: '099', name: 'ANASTASYA ARISKA F' },
                { nis: '100', name: 'ANIS AULIA' },
                { nis: '101', name: 'AQIILAH SALMA' },
                { nis: '102', name: 'AUDINA MIRELLA S' },
                { nis: '103', name: 'CHRISTIAN RIVALDO R H' },
                { nis: '104', name: 'DIRLY DARMAWAN' },
                { nis: '105', name: 'ERIDA CHRISTINA P' },
                { nis: '106', name: 'ERNA MUTIA FATANNAH' },
                { nis: '107', name: 'EVINA FITRIANI' },
                { nis: '108', name: 'FATTUR DEO PRAKAS' },
                { nis: '109', name: 'KAILA RIFA ANZANI' },
                { nis: '110', name: 'KAYLA PUTRI AURELLIA' },
                { nis: '111', name: 'KEISYA AYU SYAHRANI' },
                { nis: '112', name: 'M.BINTANG PAMUNGKAS' },
                { nis: '113', name: 'MAULANA DIMAS ADITYA' },
                { nis: '114', name: 'MAURA AMELIA PUTRI R' },
                { nis: '115', name: 'MEUTYA SALSHABILLA' },
                { nis: '116', name: 'MUHAMMAD FAHREL' },
                { nis: '117', name: 'M. RHASYAH ARYA PUTRA' },
                { nis: '118', name: 'NIKOLAS SAPUTRA' },
                { nis: '119', name: 'NOVITA ELVIANI' },
                { nis: '120', name: 'NUR FAHMI LAELA' },
                { nis: '121', name: 'NUR\'AINI SYARIFAH' },
                { nis: '122', name: 'NURILMAN ALHALUBI' },
                { nis: '123', name: 'RASYA HAIKAL AL GHIFARI' },
                { nis: '124', name: 'RICA AULIA AGUSTIN' },
                { nis: '125', name: 'RIMA ALVIAH YULISTIARA' },
                { nis: '126', name: 'RIZKI FEBRIYANI' },
                { nis: '127', name: 'ROBBY ARDIANSYAH' },
                { nis: '128', name: 'SALSABILLA' },
                { nis: '129', name: 'SYIFA NURAINI' },
                { nis: '130', name: 'TALITA AULIA ANANDA' },
                { nis: '131', name: 'TITA AULIA' },
                { nis: '132', name: 'YUSUF RAMADHAN' },
                { nis: '133', name: 'ZAKI HIBBATUL WAFI' },
                { nis: '134', name: 'ZALFA LINGGA SAPUTRA' },
                { nis: '135', name: 'ZARQA SHAFIKA KAILA' }
            ];

            defaultStudents.forEach((studentData, index) => {
                const newStudent = {
                    id: Date.now() + index,
                    name: studentData.name,
                    studentId: studentData.nis,
                    dateAdded: new Date().toISOString()
                };
                students.push(newStudent);
            });

            localStorage.setItem('students', JSON.stringify(students));
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('text-gray-600');
            });
            
            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('bg-blue-500', 'text-white');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-600');
            
            // Update data when switching tabs
            if (tabName === 'laporan') {
                updateStatistics();
                renderAttendanceHistory();
            } else if (tabName === 'rekap') {
                renderStudentRecap();
            }
        }

        // Date management
        function updateCurrentDate() {
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('current-date').textContent = today.toLocaleDateString('id-ID', options);
        }

        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        // Student management
        function addStudent(event) {
            event.preventDefault();
            
            const name = document.getElementById('student-name').value.trim();
            const studentId = document.getElementById('student-id').value.trim();
            
            if (!name) return;
            
            const newStudent = {
                id: Date.now(),
                name: name,
                studentId: studentId || `S${students.length + 1}`,
                dateAdded: new Date().toISOString()
            };
            
            students.push(newStudent);
            localStorage.setItem('students', JSON.stringify(students));
            
            // Reset form
            document.getElementById('student-name').value = '';
            document.getElementById('student-id').value = '';
            
            renderStudentList();
            renderAbsenList();
            updateStatistics();
        }

        function removeStudent(studentId) {
            if (confirm('Yakin ingin menghapus siswa ini?')) {
                students = students.filter(s => s.id !== studentId);
                localStorage.setItem('students', JSON.stringify(students));
                
                renderStudentList();
                renderAbsenList();
                updateStatistics();
            }
        }

        function renderStudentList() {
            const container = document.getElementById('student-list');
            
            if (students.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada siswa. Tambahkan siswa baru di atas.</p>';
                return;
            }
            
            container.innerHTML = students.map(student => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                        <div class="font-medium text-gray-800">${student.name}</div>
                        <div class="text-sm text-gray-500">NIS: ${student.studentId}</div>
                    </div>
                    <button onclick="removeStudent(${student.id})" 
                            class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-colors">
                        ğŸ—‘ï¸
                    </button>
                </div>
            `).join('');
        }

        // Attendance management
        function loadTodayAttendance() {
            const today = getTodayString();
            const todayRecord = attendanceHistory.find(record => record.date === today);
            
            if (todayRecord) {
                todayAttendance = { ...todayRecord.attendance };
            } else {
                todayAttendance = {};
            }
        }

        function renderAbsenList() {
            const container = document.getElementById('absen-list');
            
            if (students.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada siswa untuk diabsen. Tambahkan siswa terlebih dahulu.</p>';
                return;
            }
            
            container.innerHTML = students.map(student => {
                const status = todayAttendance[student.id] || 'belum';
                return `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <span class="text-blue-600 font-semibold">${student.name.charAt(0)}</span>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">${student.name}</div>
                                <div class="text-sm text-gray-500">NIS: ${student.studentId}</div>
                            </div>
                        </div>
                        <div class="flex space-x-2 flex-wrap">
                            <button onclick="openPhotoModal(${student.id}, '${student.name.replace(/'/g, "\\'")}', 'hadir')" 
                                    class="px-4 py-2 rounded-lg font-medium transition-colors ${status === 'hadir' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-green-100'} flex items-center space-x-1">
                                <span>ğŸ“¸</span>
                                <span>Hadir</span>
                            </button>
                            <button onclick="markAttendance(${student.id}, 'tidak-hadir')" 
                                    class="px-4 py-2 rounded-lg font-medium transition-colors ${status === 'tidak-hadir' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-red-100'}">
                                âŒ Tidak Hadir
                            </button>
                            <button onclick="markAttendance(${student.id}, 'izin')" 
                                    class="px-4 py-2 rounded-lg font-medium transition-colors ${status === 'izin' ? 'bg-yellow-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-yellow-100'}">
                                ğŸ“ Izin
                            </button>
                            <button onclick="markAttendance(${student.id}, 'sakit')" 
                                    class="px-4 py-2 rounded-lg font-medium transition-colors ${status === 'sakit' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-orange-100'}">
                                ğŸ¤’ Sakit
                            </button>
                            ${status === 'hadir' && todayAttendance[student.id + '_photo'] ? `
                                <button onclick="viewPhoto(${student.id})" 
                                        class="px-3 py-2 rounded-lg font-medium bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors text-sm">
                                    ğŸ‘ï¸ Lihat Foto
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function markAttendance(studentId, status) {
            todayAttendance[studentId] = status;
            renderAbsenList();
            updateStatistics();
        }

        function markAllPresent() {
            students.forEach(student => {
                todayAttendance[student.id] = 'hadir';
            });
            renderAbsenList();
            updateStatistics();
        }

        function saveAttendance() {
            const today = getTodayString();
            const saveBtn = event.target;
            
            // Show loading state with pulse effect
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = 'â³ Menyimpan...';
            saveBtn.disabled = true;
            saveBtn.classList.add('opacity-50', 'cursor-not-allowed', 'animate-pulse');
            
            // Add loading animation
            showLoadingOverlay('ğŸ’¾ Menyimpan data absensi ke HTML script...');
            
            // Simulate processing time for better UX
            setTimeout(() => {
                // Remove existing record for today
                attendanceHistory = attendanceHistory.filter(record => record.date !== today);
                
                // Add new record with enhanced metadata
                const newRecord = {
                    date: today,
                    attendance: { ...todayAttendance },
                    timestamp: new Date().toISOString(),
                    totalStudents: students.length,
                    presentCount: Object.values(todayAttendance).filter(status => status === 'hadir').length,
                    metadata: {
                        savedAt: new Date().toLocaleString('id-ID'),
                        version: '1.0',
                        source: 'HTML_Script_Storage'
                    }
                };
                
                attendanceHistory.push(newRecord);
                
                // Save to localStorage (HTML script storage)
                localStorage.setItem('attendanceHistory', JSON.stringify(attendanceHistory));
                localStorage.setItem('lastSaved', new Date().toISOString());
                
                // Also save to a backup object in the script
                window.attendanceBackup = {
                    data: attendanceHistory,
                    students: students,
                    lastUpdate: new Date().toISOString()
                };
                
                // Hide loading overlay
                hideLoadingOverlay();
                
                // Reset button with success state
                saveBtn.innerHTML = 'âœ… Tersimpan!';
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'animate-pulse');
                saveBtn.classList.add('bg-green-500', 'pulse-success');
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('bg-green-500', 'pulse-success');
                }, 2000);
                
                // Show success animation with storage info
                showSuccessAnimation('âœ… Data tersimpan di HTML script!');
                showStorageInfo(newRecord);
                
                // Add confetti effect
                createConfetti();
                
                updateStatistics();
                renderAttendanceHistory();
            }, 1500);
        }

        // Statistics and reporting
        function updateStatistics() {
            const totalStudents = students.length;
            const presentCount = Object.values(todayAttendance).filter(status => status === 'hadir').length;
            const absentCount = Object.values(todayAttendance).filter(status => status === 'tidak-hadir').length;
            const izinCount = Object.values(todayAttendance).filter(status => status === 'izin').length;
            const sakitCount = Object.values(todayAttendance).filter(status => status === 'sakit').length;
            
            document.getElementById('total-students').textContent = totalStudents;
            document.getElementById('total-present').textContent = presentCount;
            document.getElementById('total-absent').textContent = absentCount;
            document.getElementById('total-izin').textContent = izinCount;
            document.getElementById('total-sakit').textContent = sakitCount;
        }

        function renderAttendanceHistory() {
            const container = document.getElementById('attendance-history');
            const dataToShow = filteredHistory.length > 0 ? filteredHistory : attendanceHistory;
            
            if (dataToShow.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Tidak ada data yang sesuai dengan filter.</p>';
                return;
            }
            
            const sortedHistory = dataToShow.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = sortedHistory.map(record => {
                const date = new Date(record.date).toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const presentCount = Object.values(record.attendance).filter(status => status === 'hadir').length;
                const absentCount = Object.values(record.attendance).filter(status => status === 'tidak-hadir').length;
                const izinCount = Object.values(record.attendance).filter(status => status === 'izin').length;
                const sakitCount = Object.values(record.attendance).filter(status => status === 'sakit').length;
                const totalStudents = Object.keys(record.attendance).length;
                
                return `
                    <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <div class="font-medium text-gray-800">${date}</div>
                                <div class="text-sm text-gray-500">
                                    Total: ${totalStudents} siswa
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="flex flex-wrap gap-2 text-sm">
                                    <span class="text-green-600">âœ… ${presentCount} Hadir</span>
                                    <span class="text-red-600">âŒ ${absentCount} Tidak Hadir</span>
                                    <span class="text-yellow-600">ğŸ“ ${izinCount} Izin</span>
                                    <span class="text-orange-600">ğŸ¤’ ${sakitCount} Sakit</span>
                                </div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: ${totalStudents > 0 ? (presentCount / totalStudents) * 100 : 0}%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Tingkat kehadiran: ${totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0}%
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter functions
        function applyFilter() {
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const status = document.getElementById('filter-status').value;
            
            filteredHistory = attendanceHistory.filter(record => {
                let matchDate = true;
                let matchStatus = true;
                
                // Filter by date range
                if (startDate && endDate) {
                    const recordDate = new Date(record.date);
                    const filterStart = new Date(startDate);
                    const filterEnd = new Date(endDate);
                    matchDate = recordDate >= filterStart && recordDate <= filterEnd;
                } else if (startDate) {
                    const recordDate = new Date(record.date);
                    const filterStart = new Date(startDate);
                    matchDate = recordDate >= filterStart;
                } else if (endDate) {
                    const recordDate = new Date(record.date);
                    const filterEnd = new Date(endDate);
                    matchDate = recordDate <= filterEnd;
                }
                
                // Filter by status (check if any student has the selected status)
                if (status) {
                    matchStatus = Object.values(record.attendance).includes(status);
                }
                
                return matchDate && matchStatus;
            });
            
            updateFilterInfo();
            renderAttendanceHistory();
        }

        function resetFilter() {
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            document.getElementById('filter-status').value = '';
            
            filteredHistory = [];
            updateFilterInfo();
            renderAttendanceHistory();
        }

        function updateFilterInfo() {
            const infoElement = document.getElementById('filter-info');
            const dataCount = filteredHistory.length > 0 ? filteredHistory.length : attendanceHistory.length;
            const totalCount = attendanceHistory.length;
            
            if (filteredHistory.length > 0) {
                infoElement.textContent = `Menampilkan ${dataCount} dari ${totalCount} data`;
            } else {
                infoElement.textContent = `Menampilkan semua data (${totalCount})`;
            }
        }

        // Export functions
        function exportToExcel(type) {
            const dataToExport = type === 'filtered' && filteredHistory.length > 0 ? filteredHistory : attendanceHistory;
            
            if (dataToExport.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }

            // Create CSV content
            let csvContent = 'Tanggal,Nama Siswa,NIS,Status Kehadiran\n';
            
            dataToExport.forEach(record => {
                const date = new Date(record.date).toLocaleDateString('id-ID');
                
                Object.entries(record.attendance).forEach(([studentId, status]) => {
                    const student = students.find(s => s.id == studentId);
                    if (student) {
                        const statusText = status === 'hadir' ? 'Hadir' : 
                                         status === 'tidak-hadir' ? 'Tidak Hadir' : 
                                         status === 'izin' ? 'Izin' : 'Sakit';
                        csvContent += `"${date}","${student.name}","${student.studentId}","${statusText}"\n`;
                    }
                });
            });

            downloadCSV(csvContent, `Rekap_Absensi_${type === 'filtered' ? 'Terfilter' : 'Lengkap'}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportStudentList() {
            if (students.length === 0) {
                alert('Tidak ada data siswa untuk diekspor!');
                return;
            }

            let csvContent = 'No,Nama Siswa,NIS,Tanggal Ditambahkan\n';
            
            students.forEach((student, index) => {
                const dateAdded = new Date(student.dateAdded).toLocaleDateString('id-ID');
                csvContent += `${index + 1},"${student.name}","${student.studentId}","${dateAdded}"\n`;
            });

            downloadCSV(csvContent, `Daftar_Siswa_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportSummaryReport() {
            if (attendanceHistory.length === 0) {
                alert('Tidak ada data absensi untuk membuat laporan ringkasan!');
                return;
            }

            let csvContent = 'Tanggal,Total Siswa,Hadir,Tidak Hadir,Izin,Sakit,Persentase Kehadiran\n';
            
            const dataToProcess = filteredHistory.length > 0 ? filteredHistory : attendanceHistory;
            
            dataToProcess.forEach(record => {
                const date = new Date(record.date).toLocaleDateString('id-ID');
                const presentCount = Object.values(record.attendance).filter(status => status === 'hadir').length;
                const absentCount = Object.values(record.attendance).filter(status => status === 'tidak-hadir').length;
                const izinCount = Object.values(record.attendance).filter(status => status === 'izin').length;
                const sakitCount = Object.values(record.attendance).filter(status => status === 'sakit').length;
                const totalStudents = Object.keys(record.attendance).length;
                const percentage = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;
                
                csvContent += `"${date}",${totalStudents},${presentCount},${absentCount},${izinCount},${sakitCount},${percentage}%\n`;
            });

            // Add summary statistics
            csvContent += '\n\nRINGKASAN STATISTIK\n';
            csvContent += 'Metrik,Nilai\n';
            
            const totalDays = dataToProcess.length;
            const totalPresent = dataToProcess.reduce((sum, record) => 
                sum + Object.values(record.attendance).filter(status => status === 'hadir').length, 0);
            const totalAbsent = dataToProcess.reduce((sum, record) => 
                sum + Object.values(record.attendance).filter(status => status === 'tidak-hadir').length, 0);
            const totalIzin = dataToProcess.reduce((sum, record) => 
                sum + Object.values(record.attendance).filter(status => status === 'izin').length, 0);
            const totalSakit = dataToProcess.reduce((sum, record) => 
                sum + Object.values(record.attendance).filter(status => status === 'sakit').length, 0);
            const avgAttendance = totalDays > 0 ? Math.round((totalPresent / (totalPresent + totalAbsent + totalIzin + totalSakit)) * 100) : 0;
            
            csvContent += `"Total Hari Absensi",${totalDays}\n`;
            csvContent += `"Total Kehadiran",${totalPresent}\n`;
            csvContent += `"Total Ketidakhadiran",${totalAbsent}\n`;
            csvContent += `"Total Izin",${totalIzin}\n`;
            csvContent += `"Total Sakit",${totalSakit}\n`;
            csvContent += `"Rata-rata Kehadiran",${avgAttendance}%\n`;
            csvContent += `"Total Siswa Terdaftar",${students.length}\n`;

            downloadCSV(csvContent, `Laporan_Ringkasan_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Photo functions
        function openPhotoModal(studentId, studentName, status) {
            currentStudentId = studentId;
            currentStudentName = studentName;
            
            document.getElementById('modal-title').textContent = `Absen Foto - ${studentName}`;
            document.getElementById('photo-modal').classList.remove('hidden');
            
            // Reset modal state
            resetModalState();
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').classList.add('hidden');
            stopCamera();
            resetModalState();
        }

        function resetModalState() {
            // Hide all buttons except start camera
            document.getElementById('start-camera-btn').classList.remove('hidden');
            document.getElementById('take-photo-btn').classList.add('hidden');
            document.getElementById('retake-photo-btn').classList.add('hidden');
            document.getElementById('confirm-photo-btn').classList.add('hidden');
            
            // Show placeholder, hide video and canvas
            document.getElementById('camera-placeholder').classList.remove('hidden');
            document.getElementById('camera-video').classList.add('hidden');
            document.getElementById('photo-canvas').classList.add('hidden');
            
            capturedPhoto = null;
        }

        async function startCamera() {
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                });
                
                const video = document.getElementById('camera-video');
                video.srcObject = currentStream;
                
                // Show video, hide placeholder
                document.getElementById('camera-placeholder').classList.add('hidden');
                video.classList.remove('hidden');
                
                // Update buttons
                document.getElementById('start-camera-btn').classList.add('hidden');
                document.getElementById('take-photo-btn').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Tidak dapat mengakses kamera. Pastikan browser memiliki izin kamera.');
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function takePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('photo-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            ctx.drawImage(video, 0, 0);
            
            // Convert to base64
            capturedPhoto = canvas.toDataURL('image/jpeg', 0.8);
            
            // Show canvas, hide video
            video.classList.add('hidden');
            canvas.classList.remove('hidden');
            
            // Update buttons
            document.getElementById('take-photo-btn').classList.add('hidden');
            document.getElementById('retake-photo-btn').classList.remove('hidden');
            document.getElementById('confirm-photo-btn').classList.remove('hidden');
            
            // Stop camera
            stopCamera();
        }

        function retakePhoto() {
            // Hide canvas, show placeholder
            document.getElementById('photo-canvas').classList.add('hidden');
            document.getElementById('camera-placeholder').classList.remove('hidden');
            
            // Reset buttons
            document.getElementById('retake-photo-btn').classList.add('hidden');
            document.getElementById('confirm-photo-btn').classList.add('hidden');
            document.getElementById('start-camera-btn').classList.remove('hidden');
            
            capturedPhoto = null;
        }

        function confirmPhoto() {
            if (capturedPhoto && currentStudentId) {
                // Mark attendance with photo
                todayAttendance[currentStudentId] = 'hadir';
                todayAttendance[currentStudentId + '_photo'] = capturedPhoto;
                todayAttendance[currentStudentId + '_photo_time'] = new Date().toISOString();
                
                // Download photo to simulate saving to folder structure
                downloadPhoto(capturedPhoto, currentStudentName, currentStudentId);
                
                // Close modal and refresh list
                closePhotoModal();
                renderAbsenList();
                updateStatistics();
                
                // Show success message
                showToast(`âœ… Absensi foto ${currentStudentName} berhasil disimpan!`);
            }
        }

        function downloadPhoto(photoData, studentName, studentId) {
            // Create folder structure simulation: Absen/YYYY-MM-DD/
            const today = new Date();
            const dateFolder = today.toISOString().split('T')[0]; // YYYY-MM-DD format
            const timeStamp = today.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS format
            
            // Create filename with student info and timestamp
            const filename = `${studentId}_${studentName.replace(/[^a-zA-Z0-9]/g, '_')}_${timeStamp}.jpg`;
            const folderPath = `Absen/${dateFolder}`;
            
            // Convert base64 to blob
            const byteCharacters = atob(photoData.split(',')[1]);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/jpeg' });
            
            // Create download link
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Show folder structure info
            console.log(`ğŸ“ Foto disimpan ke: ${folderPath}/${filename}`);
            
            // Store folder info for display
            if (!todayAttendance['_folder_info']) {
                todayAttendance['_folder_info'] = folderPath;
            }
        }

        function viewPhoto(studentId) {
            const photoData = todayAttendance[studentId + '_photo'];
            const student = students.find(s => s.id === studentId);
            
            if (photoData && student) {
                document.getElementById('view-modal-title').textContent = `Foto Absensi - ${student.name}`;
                document.getElementById('view-photo-img').src = photoData;
                document.getElementById('photo-view-modal').classList.remove('hidden');
            }
        }

        function closePhotoViewModal() {
            document.getElementById('photo-view-modal').classList.add('hidden');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 3000);
        }

        // Student Recap Functions
        function renderStudentRecap() {
            const container = document.getElementById('student-recap-table');
            const startDate = document.getElementById('recap-start-date').value;
            const endDate = document.getElementById('recap-end-date').value;
            
            // Filter attendance history by date range
            let filteredData = attendanceHistory;
            if (startDate || endDate) {
                filteredData = attendanceHistory.filter(record => {
                    const recordDate = new Date(record.date);
                    let matchDate = true;
                    
                    if (startDate && endDate) {
                        const filterStart = new Date(startDate);
                        const filterEnd = new Date(endDate);
                        matchDate = recordDate >= filterStart && recordDate <= filterEnd;
                    } else if (startDate) {
                        const filterStart = new Date(startDate);
                        matchDate = recordDate >= filterStart;
                    } else if (endDate) {
                        const filterEnd = new Date(endDate);
                        matchDate = recordDate <= filterEnd;
                    }
                    
                    return matchDate;
                });
            }
            
            if (students.length === 0) {
                container.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">Belum ada data siswa.</td></tr>';
                updateRecapSummary([], 0);
                return;
            }
            
            // Calculate recap for each student
            const studentRecaps = students.map((student, index) => {
                let hadir = 0, tidakHadir = 0, izin = 0, sakit = 0;
                
                filteredData.forEach(record => {
                    const status = record.attendance[student.id];
                    if (status === 'hadir') hadir++;
                    else if (status === 'tidak-hadir') tidakHadir++;
                    else if (status === 'izin') izin++;
                    else if (status === 'sakit') sakit++;
                });
                
                const totalDays = hadir + tidakHadir + izin + sakit;
                const percentage = totalDays > 0 ? Math.round((hadir / totalDays) * 100) : 0;
                
                return {
                    ...student,
                    index: index + 1,
                    hadir,
                    tidakHadir,
                    izin,
                    sakit,
                    totalDays,
                    percentage
                };
            });
            
            // Sort by attendance percentage (descending)
            studentRecaps.sort((a, b) => b.percentage - a.percentage);
            
            container.innerHTML = studentRecaps.map(student => {
                const percentageColor = student.percentage >= 90 ? 'text-green-600' : 
                                      student.percentage >= 75 ? 'text-yellow-600' : 'text-red-600';
                
                return `
                    <tr class="hover:bg-gray-50 ${student.percentage < 75 ? 'bg-red-50' : ''}">
                        <td class="border border-gray-300 px-4 py-2 text-center">${student.index}</td>
                        <td class="border border-gray-300 px-4 py-2 font-medium">${student.studentId}</td>
                        <td class="border border-gray-300 px-4 py-2 font-medium">${student.name}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-green-600 font-semibold">${student.hadir}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-red-600 font-semibold">${student.tidakHadir}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-yellow-600 font-semibold">${student.izin}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-orange-600 font-semibold">${student.sakit}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-blue-600 font-semibold">${student.totalDays}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center font-bold ${percentageColor}">${student.percentage}%</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">
                            <button onclick="showStudentDetail(${student.id})" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ğŸ“‹ Detail
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateRecapSummary(studentRecaps, filteredData.length);
        }

        function updateRecapSummary(studentRecaps, totalDays) {
            if (studentRecaps.length === 0) {
                document.getElementById('avg-attendance').textContent = '0%';
                document.getElementById('total-days-recap').textContent = '0';
                document.getElementById('best-attendance').textContent = '-';
                document.getElementById('needs-attention').textContent = '0';
                return;
            }
            
            const avgAttendance = Math.round(studentRecaps.reduce((sum, s) => sum + s.percentage, 0) / studentRecaps.length);
            const bestStudent = studentRecaps[0];
            const needsAttention = studentRecaps.filter(s => s.percentage < 75).length;
            
            document.getElementById('avg-attendance').textContent = avgAttendance + '%';
            document.getElementById('total-days-recap').textContent = totalDays;
            document.getElementById('best-attendance').textContent = bestStudent ? `${bestStudent.name} (${bestStudent.percentage}%)` : '-';
            document.getElementById('needs-attention').textContent = needsAttention;
        }

        function applyRecapFilter() {
            renderStudentRecap();
        }

        function refreshStudentRecap() {
            document.getElementById('recap-start-date').value = '';
            document.getElementById('recap-end-date').value = '';
            document.getElementById('student-search').value = '';
            renderStudentRecap();
        }

        function searchStudent() {
            const searchTerm = document.getElementById('student-search').value.toLowerCase();
            const rows = document.querySelectorAll('#student-recap-table tr');
            
            rows.forEach(row => {
                const studentName = row.cells[2]?.textContent.toLowerCase() || '';
                const studentNis = row.cells[1]?.textContent.toLowerCase() || '';
                
                if (studentName.includes(searchTerm) || studentNis.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function showStudentDetail(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Set modal title
            document.getElementById('detail-student-name').textContent = student.name;
            document.getElementById('detail-student-info').textContent = `NIS: ${student.studentId}`;
            
            // Calculate student statistics
            let hadir = 0, tidakHadir = 0, izin = 0, sakit = 0;
            const studentHistory = [];
            
            attendanceHistory.forEach(record => {
                const status = record.attendance[studentId];
                if (status) {
                    if (status === 'hadir') hadir++;
                    else if (status === 'tidak-hadir') tidakHadir++;
                    else if (status === 'izin') izin++;
                    else if (status === 'sakit') sakit++;
                    
                    studentHistory.push({
                        date: record.date,
                        status: status,
                        hasPhoto: !!record.attendance[studentId + '_photo']
                    });
                }
            });
            
            const totalDays = hadir + tidakHadir + izin + sakit;
            const percentage = totalDays > 0 ? Math.round((hadir / totalDays) * 100) : 0;
            
            // Update summary cards
            document.getElementById('detail-hadir').textContent = hadir;
            document.getElementById('detail-tidak-hadir').textContent = tidakHadir;
            document.getElementById('detail-izin').textContent = izin;
            document.getElementById('detail-sakit').textContent = sakit;
            document.getElementById('detail-percentage').textContent = percentage + '%';
            
            // Render attendance history table
            const tableBody = document.getElementById('detail-attendance-table');
            studentHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tableBody.innerHTML = studentHistory.map(record => {
                const date = new Date(record.date).toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const statusText = record.status === 'hadir' ? 'âœ… Hadir' :
                                 record.status === 'tidak-hadir' ? 'âŒ Tidak Hadir' :
                                 record.status === 'izin' ? 'ğŸ“ Izin' : 'ğŸ¤’ Sakit';
                
                const statusColor = record.status === 'hadir' ? 'text-green-600' :
                                  record.status === 'tidak-hadir' ? 'text-red-600' :
                                  record.status === 'izin' ? 'text-yellow-600' : 'text-orange-600';
                
                const keterangan = record.status === 'hadir' && record.hasPhoto ? 'Dengan foto' : '-';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-2">${date}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center font-semibold ${statusColor}">${statusText}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center text-sm text-gray-600">${keterangan}</td>
                    </tr>
                `;
            }).join('');
            
            if (studentHistory.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">Belum ada data kehadiran</td></tr>';
            }
            
            // Show modal
            document.getElementById('student-detail-modal').classList.remove('hidden');
        }

        function closeStudentDetailModal() {
            document.getElementById('student-detail-modal').classList.add('hidden');
        }

        function exportStudentRecap() {
            if (students.length === 0) {
                alert('Tidak ada data siswa untuk diekspor!');
                return;
            }

            const startDate = document.getElementById('recap-start-date').value;
            const endDate = document.getElementById('recap-end-date').value;
            
            // Filter attendance history by date range
            let filteredData = attendanceHistory;
            if (startDate || endDate) {
                filteredData = attendanceHistory.filter(record => {
                    const recordDate = new Date(record.date);
                    let matchDate = true;
                    
                    if (startDate && endDate) {
                        const filterStart = new Date(startDate);
                        const filterEnd = new Date(endDate);
                        matchDate = recordDate >= filterStart && recordDate <= filterEnd;
                    } else if (startDate) {
                        const filterStart = new Date(startDate);
                        matchDate = recordDate >= filterStart;
                    } else if (endDate) {
                        const filterEnd = new Date(endDate);
                        matchDate = recordDate <= filterEnd;
                    }
                    
                    return matchDate;
                });
            }

            let csvContent = 'No,NIS,Nama Siswa,Hadir,Tidak Hadir,Izin,Sakit,Total Hari,Persentase Kehadiran\n';
            
            students.forEach((student, index) => {
                let hadir = 0, tidakHadir = 0, izin = 0, sakit = 0;
                
                filteredData.forEach(record => {
                    const status = record.attendance[student.id];
                    if (status === 'hadir') hadir++;
                    else if (status === 'tidak-hadir') tidakHadir++;
                    else if (status === 'izin') izin++;
                    else if (status === 'sakit') sakit++;
                });
                
                const totalDays = hadir + tidakHadir + izin + sakit;
                const percentage = totalDays > 0 ? Math.round((hadir / totalDays) * 100) : 0;
                
                csvContent += `${index + 1},"${student.studentId}","${student.name}",${hadir},${tidakHadir},${izin},${sakit},${totalDays},${percentage}%\n`;
            });

            const periodText = startDate && endDate ? `_${startDate}_sampai_${endDate}` : 
                              startDate ? `_dari_${startDate}` : 
                              endDate ? `_sampai_${endDate}` : '';
            
            downloadCSV(csvContent, `Rekap_Kehadiran_Siswa${periodText}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csvContent, filename) {
            // Add BOM for proper UTF-8 encoding in Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            showSuccessToast(`âœ… File ${filename} berhasil diunduh!`);
        }

        // Visual Effects Functions
        function showLoadingOverlay(message) {
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            overlay.innerHTML = `
                <div class="bg-white rounded-xl p-8 text-center shadow-2xl">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <p class="text-gray-700 font-medium">${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => {
                    if (document.body.contains(overlay)) {
                        document.body.removeChild(overlay);
                    }
                }, 300);
            }
        }

        function showSuccessAnimation(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed inset-0 z-50 flex items-center justify-center pointer-events-none';
            successDiv.innerHTML = `
                <div class="bg-green-500 text-white px-8 py-4 rounded-xl shadow-2xl transform scale-0 animate-bounce">
                    <div class="text-2xl font-bold text-center">${message}</div>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            // Animate in
            setTimeout(() => {
                successDiv.firstElementChild.classList.remove('scale-0');
                successDiv.firstElementChild.classList.add('scale-100', 'transition-transform', 'duration-500');
            }, 100);
            
            // Animate out
            setTimeout(() => {
                successDiv.firstElementChild.classList.add('scale-0', 'opacity-0');
                setTimeout(() => {
                    if (document.body.contains(successDiv)) {
                        document.body.removeChild(successDiv);
                    }
                }, 500);
            }, 2000);
        }

        function showSuccessToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd', '#98d8c8'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'fixed pointer-events-none z-40';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = '-10px';
                    confetti.style.width = '10px';
                    confetti.style.height = '10px';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = '50%';
                    confetti.style.animation = `confetti-fall ${2 + Math.random() * 3}s linear forwards`;
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        if (document.body.contains(confetti)) {
                            document.body.removeChild(confetti);
                        }
                    }, 5000);
                }, i * 50);
            }
        }

        // Spreadsheet Integration Functions
        function sendToSpreadsheet() {
            const today = getTodayString();
            const todayRecord = attendanceHistory.find(record => record.date === today);
            
            if (!todayRecord) {
                showErrorToast('âŒ Belum ada data absensi hari ini untuk dikirim!');
                return;
            }
            
            const sendBtn = event.target;
            const originalHTML = sendBtn.innerHTML;
            
            // Show loading state
            sendBtn.innerHTML = 'â³ Mengirim...';
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            showLoadingOverlay('Mengirim data ke Google Spreadsheet...');
            
            // Prepare data for spreadsheet
            const spreadsheetData = prepareSpreadsheetData(todayRecord);
            
            // Simulate API call (replace with actual Google Sheets API)
            setTimeout(() => {
                // In real implementation, you would call Google Sheets API here
                // Example: sendToGoogleSheets(spreadsheetData)
                
                hideLoadingOverlay();
                
                // Reset button
                sendBtn.innerHTML = originalHTML;
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                // Show success
                showSuccessAnimation('ğŸ“Š Data berhasil dikirim ke Spreadsheet!');
                createConfetti();
                
                // Show spreadsheet URL (demo)
                showSpreadsheetModal(spreadsheetData);
                
            }, 2000);
        }

        function prepareSpreadsheetData(attendanceRecord) {
            const date = new Date(attendanceRecord.date).toLocaleDateString('id-ID');
            const data = [];
            
            // Header row
            data.push(['Tanggal', 'NIS', 'Nama Siswa', 'Status', 'Waktu Absen', 'Keterangan']);
            
            // Data rows
            Object.entries(attendanceRecord.attendance).forEach(([studentId, status]) => {
                if (!studentId.includes('_')) { // Skip photo and metadata entries
                    const student = students.find(s => s.id == studentId);
                    if (student) {
                        const hasPhoto = !!attendanceRecord.attendance[studentId + '_photo'];
                        const photoTime = attendanceRecord.attendance[studentId + '_photo_time'];
                        const timeStamp = photoTime ? new Date(photoTime).toLocaleTimeString('id-ID') : '-';
                        const keterangan = hasPhoto ? 'Dengan foto' : 'Tanpa foto';
                        
                        const statusText = status === 'hadir' ? 'Hadir' :
                                         status === 'tidak-hadir' ? 'Tidak Hadir' :
                                         status === 'izin' ? 'Izin' : 'Sakit';
                        
                        data.push([date, student.studentId, student.name, statusText, timeStamp, keterangan]);
                    }
                }
            });
            
            return data;
        }

        function showSpreadsheetModal(data) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-semibold text-gray-800">ğŸ“Š Data Terkirim ke Spreadsheet</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center space-x-2 text-green-700">
                                <span class="text-xl">âœ…</span>
                                <span class="font-medium">Data berhasil dikirim!</span>
                            </div>
                            <p class="text-sm text-green-600 mt-1">
                                ${data.length - 1} siswa telah dikirim ke Google Spreadsheet
                            </p>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Preview Data yang Dikirim:</h4>
                            <div class="overflow-x-auto border border-gray-300 rounded-lg">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            ${data[0].map(header => `<th class="px-3 py-2 text-left font-medium text-gray-700 border-b">${header}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.slice(1, 6).map(row => `
                                            <tr class="hover:bg-gray-50">
                                                ${row.map(cell => `<td class="px-3 py-2 border-b text-gray-600">${cell}</td>`).join('')}
                                            </tr>
                                        `).join('')}
                                        ${data.length > 6 ? `
                                            <tr>
                                                <td colspan="${data[0].length}" class="px-3 py-2 text-center text-gray-500 italic">
                                                    ... dan ${data.length - 6} data lainnya
                                                </td>
                                            </tr>
                                        ` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-blue-700 mb-2">ğŸ”— Link Spreadsheet (Demo)</h4>
                            <p class="text-sm text-blue-600 mb-2">
                                Data telah dikirim ke Google Spreadsheet Anda:
                            </p>
                            <div class="bg-white border border-blue-300 rounded px-3 py-2 text-sm font-mono text-blue-800">
                                https://docs.google.com/spreadsheets/d/1ABC123.../edit
                            </div>
                            <p class="text-xs text-blue-500 mt-2">
                                * Ini adalah contoh URL. Dalam implementasi nyata, Anda perlu mengonfigurasi Google Sheets API.
                            </p>
                        </div>
                        
                        <div class="flex justify-center space-x-3">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                Tutup
                            </button>
                            <button onclick="openSpreadsheetSetup()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                âš™ï¸ Setup Spreadsheet
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openSpreadsheetSetup() {
            // Close current modal
            document.querySelector('.fixed').remove();
            
            const setupModal = document.createElement('div');
            setupModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            setupModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-800">âš™ï¸ Setup Google Spreadsheet</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Spreadsheet ID</label>
                                <input type="text" id="spreadsheet-id" placeholder="1ABC123DEF456..." 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">ID dari URL Google Spreadsheet Anda</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sheet Name</label>
                                <input type="text" id="sheet-name" placeholder="Absensi" value="Absensi"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                                <input type="password" id="api-key" placeholder="AIza..." 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Google Sheets API Key Anda</p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-6">
                            <h4 class="font-semibold text-yellow-700 mb-2">ğŸ“‹ Langkah Setup:</h4>
                            <ol class="text-sm text-yellow-600 space-y-1 list-decimal list-inside">
                                <li>Buat Google Spreadsheet baru</li>
                                <li>Aktifkan Google Sheets API di Google Cloud Console</li>
                                <li>Buat API Key dan masukkan di atas</li>
                                <li>Copy Spreadsheet ID dari URL</li>
                                <li>Klik "Simpan Konfigurasi"</li>
                            </ol>
                        </div>
                        
                        <div class="flex justify-center space-x-3 mt-6">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Batal
                            </button>
                            <button onclick="saveSpreadsheetConfig()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                ğŸ’¾ Simpan Konfigurasi
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(setupModal);
            
            // Load existing config
            const config = JSON.parse(localStorage.getItem('spreadsheetConfig') || '{}');
            if (config.spreadsheetId) document.getElementById('spreadsheet-id').value = config.spreadsheetId;
            if (config.sheetName) document.getElementById('sheet-name').value = config.sheetName;
            if (config.apiKey) document.getElementById('api-key').value = config.apiKey;
        }

        function saveSpreadsheetConfig() {
            const config = {
                spreadsheetId: document.getElementById('spreadsheet-id').value,
                sheetName: document.getElementById('sheet-name').value,
                apiKey: document.getElementById('api-key').value
            };
            
            if (!config.spreadsheetId || !config.apiKey) {
                showErrorToast('âŒ Spreadsheet ID dan API Key harus diisi!');
                return;
            }
            
            localStorage.setItem('spreadsheetConfig', JSON.stringify(config));
            document.querySelector('.fixed').remove();
            showSuccessToast('âœ… Konfigurasi Spreadsheet berhasil disimpan!');
        }

        function showErrorToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        function showStorageInfo(record) {
            const storageModal = document.createElement('div');
            storageModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            storageModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform scale-0 transition-transform duration-300">
                    <div class="p-6">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-3xl">ğŸ’¾</span>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-800">Data Berhasil Disimpan!</h3>
                            <p class="text-gray-600 text-sm mt-2">Tersimpan di HTML Script Storage</p>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">ğŸ“… Tanggal:</span>
                                <span class="font-medium">${new Date(record.date).toLocaleDateString('id-ID')}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">ğŸ‘¥ Total Siswa:</span>
                                <span class="font-medium">${record.totalStudents}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">âœ… Hadir:</span>
                                <span class="font-medium text-green-600">${record.presentCount}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">â° Waktu Simpan:</span>
                                <span class="font-medium">${record.metadata.savedAt}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">ğŸ’½ Storage:</span>
                                <span class="font-medium text-blue-600">localStorage + Script</span>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
                            <div class="flex items-start space-x-2">
                                <span class="text-blue-500 mt-0.5">â„¹ï¸</span>
                                <div class="text-sm text-blue-700">
                                    <p class="font-medium">Lokasi Penyimpanan:</p>
                                    <p>â€¢ Browser localStorage (utama)</p>
                                    <p>â€¢ window.attendanceBackup (cadangan)</p>
                                    <p>â€¢ Data tersimpan di script HTML ini</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-center space-x-3 mt-6">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Tutup
                            </button>
                            <button onclick="showDataDetails()" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                ğŸ“Š Lihat Detail Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(storageModal);
            
            // Animate in
            setTimeout(() => {
                storageModal.firstElementChild.classList.remove('scale-0');
                storageModal.firstElementChild.classList.add('scale-100');
            }, 100);
            
            // Auto close after 8 seconds
            setTimeout(() => {
                if (document.body.contains(storageModal)) {
                    storageModal.firstElementChild.classList.add('scale-0');
                    setTimeout(() => {
                        if (document.body.contains(storageModal)) {
                            document.body.removeChild(storageModal);
                        }
                    }, 300);
                }
            }, 8000);
        }

        function showDataDetails() {
            // Close storage info modal
            document.querySelector('.fixed').remove();
            
            const dataSize = JSON.stringify(attendanceHistory).length;
            const studentSize = JSON.stringify(students).length;
            const totalSize = dataSize + studentSize;
            
            const detailModal = document.createElement('div');
            detailModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            detailModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-800">ğŸ“Š Detail Penyimpanan Data</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="font-semibold text-green-700 mb-2">âœ… Status Penyimpanan</h4>
                                <div class="text-sm text-green-600 space-y-1">
                                    <p>â€¢ Data absensi: ${attendanceHistory.length} hari tersimpan</p>
                                    <p>â€¢ Data siswa: ${students.length} siswa terdaftar</p>
                                    <p>â€¢ Ukuran data: ~${(totalSize/1024).toFixed(1)} KB</p>
                                    <p>â€¢ Terakhir disimpan: ${localStorage.getItem('lastSaved') ? new Date(localStorage.getItem('lastSaved')).toLocaleString('id-ID') : 'Belum pernah'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-700 mb-2">ğŸ’¾ Lokasi Penyimpanan</h4>
                                <div class="text-sm text-blue-600 space-y-2">
                                    <div class="flex items-center space-x-2">
                                        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                        <span>localStorage: Aktif</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                        <span>window.attendanceBackup: Aktif</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                        <span>HTML Script Variables: Aktif</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h4 class="font-semibold text-yellow-700 mb-2">âš ï¸ Catatan Penting</h4>
                                <div class="text-sm text-yellow-600 space-y-1">
                                    <p>â€¢ Data tersimpan di browser (localStorage)</p>
                                    <p>â€¢ Data akan hilang jika cache browser dibersihkan</p>
                                    <p>â€¢ Backup data secara berkala dengan ekspor</p>
                                    <p>â€¢ Data hanya tersedia di browser ini</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-700 mb-2">ğŸ”§ Aksi Data</h4>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="exportAllData()" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                        ğŸ“¤ Ekspor Semua
                                    </button>
                                    <button onclick="clearAllData()" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                        ğŸ—‘ï¸ Hapus Semua
                                    </button>
                                    <button onclick="showBackupData()" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                        ğŸ‘ï¸ Lihat Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-6">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(detailModal);
        }

        function exportAllData() {
            const allData = {
                students: students,
                attendanceHistory: attendanceHistory,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const jsonData = JSON.stringify(allData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `Backup_Absensi_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showSuccessToast('âœ… Backup data berhasil diunduh!');
        }

        function clearAllData() {
            if (confirm('âš ï¸ PERINGATAN: Ini akan menghapus SEMUA data absensi dan siswa!\n\nApakah Anda yakin ingin melanjutkan?')) {
                if (confirm('ğŸš¨ KONFIRMASI TERAKHIR: Data yang dihapus tidak dapat dikembalikan!\n\nKlik OK untuk menghapus semua data.')) {
                    localStorage.clear();
                    students.length = 0;
                    attendanceHistory.length = 0;
                    todayAttendance = {};
                    window.attendanceBackup = null;
                    
                    // Close modal and refresh
                    document.querySelector('.fixed').remove();
                    renderStudentList();
                    renderAbsenList();
                    updateStatistics();
                    renderAttendanceHistory();
                    
                    showSuccessToast('ğŸ—‘ï¸ Semua data berhasil dihapus!');
                }
            }
        }

        function showBackupData() {
            const backup = window.attendanceBackup;
            if (!backup) {
                showErrorToast('âŒ Tidak ada data backup ditemukan!');
                return;
            }
            
            const backupModal = document.createElement('div');
            backupModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            backupModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">ğŸ’¾ Data Backup</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-gray-700 mb-2">ğŸ“Š Informasi Backup</h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p>â€¢ Terakhir update: ${new Date(backup.lastUpdate).toLocaleString('id-ID')}</p>
                                <p>â€¢ Jumlah siswa: ${backup.students.length}</p>
                                <p>â€¢ Jumlah hari absensi: ${backup.data.length}</p>
                                <p>â€¢ Ukuran backup: ~${(JSON.stringify(backup).length/1024).toFixed(1)} KB</p>
                            </div>
                        </div>
                        
                        <div class="bg-white border border-gray-300 rounded-lg p-4 max-h-60 overflow-y-auto">
                            <h4 class="font-semibold text-gray-700 mb-2">ğŸ“‹ Preview Data JSON</h4>
                            <pre class="text-xs text-gray-600 whitespace-pre-wrap">${JSON.stringify(backup, null, 2).substring(0, 1000)}${JSON.stringify(backup).length > 1000 ? '...\n\n[Data dipotong untuk preview]' : ''}</pre>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(backupModal);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9817459d74309cbc',t:'MTc1ODI2NTkxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
